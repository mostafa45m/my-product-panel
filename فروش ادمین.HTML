<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محصولات و پنل مدیریت</title>
  <style>
    body {
      font-family: "Vazir", sans-serif;
      background: #f9f9f9;
      padding: 30px;
      max-width: 1000px;
      margin: auto;
      position: relative;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }

    .search-box {
      text-align: center;
      margin-bottom: 30px;
    }

    .search-box input {
      padding: 10px;
      width: 60%;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }

    .product-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      padding: 20px;
      margin-bottom: 20px;
      gap: 20px;
      transition: 0.3s ease;
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }

    .product-card img {
      width: 90px;
      height: 90px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .product-info {
      flex: 1;
      line-height: 1.8;
    }

    .product-info p {
      margin: 0;
      color: #444;
    }

    .btn {
      padding: 6px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    #adminBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 14px;
      font-size: 13px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 999;
    }

    #adminPanel {
      display: none;
    }

    input, textarea {
      width: 100%;
      padding: 6px;
      margin: 5px 0;
      box-sizing: border-box;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      font-size: 13px;
    }

    th {
      background: #e0e0e0;
    }

    img {
      width: 80px;
      height: 80px;
    }
  </style>
</head>
<body>

<div id="mainContent">
  <h2>📦 محصولات ثبت‌شده</h2>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="🔍 جست‌وجوی محصول بر اساس نام..." oninput="renderCards()" />
  </div>
  <div id="product-list"></div>
</div>

<button id="adminBtn" onclick="enterAdmin()">پنل مدیریت</button>

<div id="adminPanel">
  <h2>پنل فروش</h2>
  <form id="sale-form">
    <input type="text" id="product-name" placeholder="نام محصول" required>
    <textarea id="product-description" placeholder="توضیحات محصول" required></textarea>
    <input type="file" id="product-image" accept="image/*">
    <input type="number" id="purchase-price" placeholder="قیمت خرید (تومان)" required>
    <input type="number" id="sale-price" placeholder="قیمت فروش (تومان)" required>
    <input type="number" id="quantity" placeholder="تعداد فروش" required>
    <input type="number" id="discount" placeholder="تخفیف (تومان)" required>
    <input type="text" id="profit" placeholder="سود (تومان)" readonly>
    <input type="text" id="total" placeholder="جمع کل (تومان)" readonly>
    <button type="submit">ثبت فروش</button>
  </form>

  <h3>لیست فروش‌ها</h3>
  <input type="text" id="search" placeholder="جست‌وجوی محصول..." onkeyup="searchTable()">

  <table id="sale-table">
    <thead>
      <tr>
        <th>تصویر</th>
        <th>نام محصول</th>
        <th>توضیحات</th>
        <th>قیمت خرید</th>
        <th>قیمت فروش</th>
        <th>تعداد</th>
        <th>تخفیف</th>
        <th>سود</th>
        <th>جمع کل</th>
        <th>موجودی</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const productList = document.getElementById("product-list");
  const searchInput = document.getElementById("searchInput");
  const adminBtn = document.getElementById("adminBtn");
  const mainContent = document.getElementById("mainContent");
  const adminPanel = document.getElementById("adminPanel");

  let sales = JSON.parse(localStorage.getItem("sales")) || [];

  function formatNumber(num) {
    return Number(num).toLocaleString("fa-IR");
  }

  function renderCards() {
    const keyword = searchInput.value.trim().toLowerCase();
    productList.innerHTML = "";

    const filtered = sales.filter(item => item.name.toLowerCase().includes(keyword));

    if (filtered.length === 0) {
      productList.innerHTML = "<p style='text-align:center; color:#777;'>محصولی پیدا نشد.</p>";
      return;
    }

    filtered.forEach((item, index) => {
      const card = document.createElement("div");
      card.className = "product-card";

      const totalPerUnit = item.salePrice - item.discount;

      card.innerHTML = `
        <img src="${item.image}" alt="product">
        <div class="product-info">
          <p><strong>نام:</strong> ${item.name}</p>
          <p><strong>قیمت فروش:</strong> ${formatNumber(item.salePrice)} تومان</p>
          <p><strong>تعداد:</strong> ${item.inventory}</p>
          <p><strong>تخفیف:</strong> ${formatNumber(item.discount)} تومان</p>
          <p><strong>قیمت نهایی:</strong> ${formatNumber(totalPerUnit)} تومان</p>
        </div>
        <button class="btn" onclick="updateInventory(${index})">کاهش موجودی</button>
      `;

      productList.appendChild(card);
    });
  }

  function updateInventory(index) {
    const count = prompt("چند عدد کم شود؟");
    if (count === null) return;

    const number = parseInt(count);
    if (isNaN(number) || number < 0) {
      alert("عدد معتبر وارد کنید.");
      return;
    }

    if (number > sales[index].inventory) {
      alert("موجودی کافی نیست.");
      return;
    }

    sales[index].inventory -= number;
    localStorage.setItem("sales", JSON.stringify(sales));
    renderCards();
    renderTable();
  }

  function enterAdmin() {
    const password = prompt("رمز عبور پنل مدیریت را وارد کنید:");
    if (password === "1234") {
      mainContent.style.display = "none";
      adminBtn.style.display = "none";
      adminPanel.style.display = "block";
      renderTable();
      history.pushState({ page: "admin" }, "", "#admin");
    } else {
      alert("رمز اشتباه است!");
    }
  }

  window.addEventListener("popstate", function (event) {
    if (event.state && event.state.page === "admin") {
      // پنل مدیریت باز است - کاری نکن
    } else {
      mainContent.style.display = "block";
      adminBtn.style.display = "block";
      adminPanel.style.display = "none";
    }
  });

  // پنل مدیریت
  const form = document.getElementById("sale-form");
  const tbody = document.querySelector("#sale-table tbody");

  document.getElementById("purchase-price").oninput =
  document.getElementById("sale-price").oninput =
  document.getElementById("discount").oninput =
  document.getElementById("quantity").oninput = calculateProfitAndTotal;

  function calculateProfitAndTotal() {
    const purchasePrice = parseInt(document.getElementById("purchase-price").value || 0);
    const salePrice = parseInt(document.getElementById("sale-price").value || 0);
    const discount = parseInt(document.getElementById("discount").value || 0);
    const quantity = parseInt(document.getElementById("quantity").value || 1);

    const profit = (salePrice - purchasePrice - discount) * quantity;
    document.getElementById("profit").value = formatNumber(profit) + " تومان";
    const total = (salePrice * quantity) - discount;
    document.getElementById("total").value = formatNumber(total) + " تومان";
  }

  function saveToStorage() {
    localStorage.setItem("sales", JSON.stringify(sales));
  }

  function renderTable() {
    tbody.innerHTML = "";
    sales.forEach((item, index) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td><img src="${item.image}" alt="Product Image"></td>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>${formatNumber(item.purchasePrice)}</td>
        <td>${formatNumber(item.salePrice)}</td>
        <td>${item.quantity}</td>
        <td>${formatNumber(item.discount)}</td>
        <td>${formatNumber(item.profit)}</td>
        <td>${formatNumber(item.total)}</td>
        <td>${item.inventory}</td>
        <td>
          <button onclick="editRow(${index})">✏️</button>
          <button onclick="deleteRow(${index})">🗑️</button>
        </td>
      `;
    });
  }

  function getBase64(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
      callback(e.target.result);
    };
    reader.readAsDataURL(file);
  }

  form.onsubmit = function(e) {
    e.preventDefault();
    const file = document.getElementById("product-image").files[0];
    if (file) {
      getBase64(file, function(base64Image) {
        saveSale(base64Image);
      });
    } else {
      saveSale("");
    }
  };

  function saveSale(base64Image) {
    const purchasePrice = parseInt(document.getElementById("purchase-price").value);
    const salePrice = parseInt(document.getElementById("sale-price").value);
    const quantity = parseInt(document.getElementById("quantity").value);
    const discount = parseInt(document.getElementById("discount").value);

    const item = {
      name: document.getElementById("product-name").value,
      description: document.getElementById("product-description").value,
      image: base64Image,
      purchasePrice,
      salePrice,
      quantity,
      inventory: quantity,
      discount,
      profit: (salePrice - purchasePrice - discount) * quantity,
      total: (salePrice * quantity) - discount
    };

    sales.push(item);
    saveToStorage();
    renderTable();
    form.reset();
    document.getElementById("profit").value = "";
    document.getElementById("total").value = "";
  }

  function deleteRow(index) {
    if (confirm("آیا مطمئن هستید؟")) {
      sales.splice(index, 1);
      saveToStorage();
      renderTable();
      renderCards();
    }
  }

  function editRow(index) {
    const item = sales[index];
    document.getElementById("product-name").value = item.name;
    document.getElementById("product-description").value = item.description;
    document.getElementById("purchase-price").value = item.purchasePrice;
    document.getElementById("sale-price").value = item.salePrice;
    document.getElementById("quantity").value = item.quantity;
    document.getElementById("discount").value = item.discount;
    document.getElementById("profit").value = formatNumber(item.profit) + " تومان";
    document.getElementById("total").value = formatNumber(item.total) + " تومان";
    sales.splice(index, 1);
    saveToStorage();
    renderTable();
  }

  function searchTable() {
    const search = document.getElementById("search").value.toLowerCase();
    const rows = tbody.querySelectorAll("tr");
    rows.forEach(row => {
      const name = row.cells[1].innerText.toLowerCase();
      row.style.display = name.includes(search) ? "" : "none";
    });
  }

  renderCards();
</script>

</body>
</html>
