<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ØªØµÙ„ Ø¨Ù‡ Google Sheets</title>
  <style>
    body {
      font-family: "Vazir", sans-serif;
      background: #f9f9f9;
      padding: 30px;
      max-width: 1000px;
      margin: auto;
      position: relative;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    .search-box {
      text-align: center;
      margin-bottom: 30px;
    }
    .search-box input {
      padding: 10px;
      width: 60%;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    .product-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      padding: 20px;
      margin-bottom: 20px;
      gap: 20px;
      transition: 0.3s ease;
    }
    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }
    .product-card img {
      width: 90px;
      height: 90px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    .product-info {
      flex: 1;
      line-height: 1.8;
    }
    .product-info p {
      margin: 0;
      color: #444;
    }
    .btn {
      padding: 6px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    #adminBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 14px;
      font-size: 13px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 999;
    }
    #adminPanel {
      display: none;
    }
    input, textarea {
      width: 100%;
      padding: 6px;
      margin: 5px 0;
      box-sizing: border-box;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      font-size: 13px;
    }
    th {
      background: #e0e0e0;
    }
    img {
      width: 80px;
      height: 80px;
    }
  </style>
</head>
<body>

<div id="mainContent">
  <h2>ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h2>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…..." oninput="renderCards()" />
  </div>
  <div id="product-list"></div>
</div>

<button id="adminBtn" onclick="enterAdmin()">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</button>

<div id="adminPanel">
  <h2>Ù¾Ù†Ù„ ÙØ±ÙˆØ´</h2>
  <form id="sale-form">
    <input type="text" id="product-name" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„" required />
    <textarea id="product-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø­ØµÙˆÙ„" required></textarea>
    <input type="file" id="product-image" accept="image/*" />
    <input type="number" id="purchase-price" placeholder="Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)" required />
    <input type="number" id="sale-price" placeholder="Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´ (ØªÙˆÙ…Ø§Ù†)" required />
    <input type="number" id="quantity" placeholder="ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´" required />
    <input type="number" id="discount" placeholder="ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)" required />
    <input type="text" id="profit" placeholder="Ø³ÙˆØ¯ (ØªÙˆÙ…Ø§Ù†)" readonly />
    <input type="text" id="total" placeholder="Ø¬Ù…Ø¹ Ú©Ù„ (ØªÙˆÙ…Ø§Ù†)" readonly />
    <button type="submit">Ø«Ø¨Øª ÙØ±ÙˆØ´</button>
  </form>

  <h3>Ù„ÛŒØ³Øª ÙØ±ÙˆØ´â€ŒÙ‡Ø§</h3>
  <input type="text" id="search" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„..." onkeyup="searchTable()" />

  <table id="sale-table">
    <thead>
      <tr>
        <th>ØªØµÙˆÛŒØ±</th>
        <th>Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„</th>
        <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
        <th>Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯</th>
        <th>Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´</th>
        <th>ØªØ¹Ø¯Ø§Ø¯</th>
        <th>ØªØ®ÙÛŒÙ</th>
        <th>Ø³ÙˆØ¯</th>
        <th>Ø¬Ù…Ø¹ Ú©Ù„</th>
        <th>Ù…ÙˆØ¬ÙˆØ¯ÛŒ</th>
        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbwK18qdDdMLMl3v5ZiOLycJOxPwIY_1A1ZEC3O9G4UhxzAnRS3CF_hbf75dPNTUB3GH8g/exec";

  const productList = document.getElementById("product-list");
  const searchInput = document.getElementById("searchInput");
  const adminBtn = document.getElementById("adminBtn");
  const mainContent = document.getElementById("mainContent");
  const adminPanel = document.getElementById("adminPanel");
  const tbody = document.querySelector("#sale-table tbody");

  let sales = [];

  // Ø¹Ø¯Ø¯ Ø±Ùˆ ÙØ§Ø±Ø³ÛŒ Ùˆ Ø³Ù‡ Ø±Ù‚Ù… Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒØ¯Ù‡
  function formatNumber(num) {
    return Number(num).toLocaleString("fa-IR");
  }

  // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ Ø§Ø² Google Sheets
  async function fetchSales() {
    try {
      const res = await fetch(SHEET_URL + "?action=get");
      const data = await res.json();
      sales = data;
      renderCards();
      renderTable();
    } catch (err) {
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Google Sheets.");
      console.error(err);
    }
  }

  // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øª Ù‡Ø§ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª)
  function renderCards() {
    const keyword = searchInput.value.trim().toLowerCase();
    productList.innerHTML = "";

    const filtered = sales.filter(item => item.name.toLowerCase().includes(keyword));

    if (filtered.length === 0) {
      productList.innerHTML = "<p style='text-align:center; color:#777;'>Ù…Ø­ØµÙˆÙ„ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p>";
      return;
    }

    filtered.forEach((item, index) => {
      const card = document.createElement("div");
      card.className = "product-card";

      const totalPerUnit = item.salePrice - item.discount;

      card.innerHTML = `
        <img src="${item.image}" alt="product" />
        <div class="product-info">
          <p><strong>Ù†Ø§Ù…:</strong> ${item.name}</p>
          <p><strong>Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´:</strong> ${formatNumber(item.salePrice)} ØªÙˆÙ…Ø§Ù†</p>
          <p><strong>ØªØ¹Ø¯Ø§Ø¯:</strong> ${item.inventory}</p>
          <p><strong>ØªØ®ÙÛŒÙ:</strong> ${formatNumber(item.discount)} ØªÙˆÙ…Ø§Ù†</p>
          <p><strong>Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ:</strong> ${formatNumber(totalPerUnit)} ØªÙˆÙ…Ø§Ù†</p>
        </div>
        <button class="btn" onclick="updateInventory(${index})">Ú©Ø§Ù‡Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
      `;

      productList.appendChild(card);
    });
  }

  // Ú©Ø§Ù‡Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª
  async function updateInventory(index) {
    const count = prompt("Ú†Ù†Ø¯ Ø¹Ø¯Ø¯ Ú©Ù… Ø´ÙˆØ¯ØŸ");
    if (count === null) return;

    const number = parseInt(count);
    if (isNaN(number) || number < 0) {
      alert("Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
      return;
    }

    if (number > sales[index].inventory) {
      alert("Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.");
      return;
    }

    const updatedInventory = sales[index].inventory - number;

    try {
      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "updateInventory",
          rowId: sales[index].rowId,
          inventory: updatedInventory
        }),
        headers: { "Content-Type": "application/json" }
      });
      const result = await res.json();

      if (result.success) {
        sales[index].inventory = updatedInventory;
        renderCards();
        renderTable();
      } else {
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ.");
      }
    } catch (err) {
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.");
      console.error(err);
    }
  }

  // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
  function enterAdmin() {
    const password = prompt("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
    if (password === "1234") {
      mainContent.style.display = "none";
      adminBtn.style.display = "none";
      adminPanel.style.display = "block";
      renderTable();
      history.pushState({ page: "admin" }, "", "#admin");
    } else {
      alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!");
    }
  }

  window.addEventListener("popstate", function (event) {
    if (event.state && event.state.page === "admin") {
      // Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø² Ø§Ø³Øª - Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
    } else {
      mainContent.style.display = "block";
      adminBtn.style.display = "block";
      adminPanel.style.display = "none";
    }
  });

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ Ùˆ Ø¬Ù…Ø¹ Ú©Ù„
  document.getElementById("purchase-price").oninput =
  document.getElementById("sale-price").oninput =
  document.getElementById("discount").oninput =
  document.getElementById("quantity").oninput = function () {
    const pur = +document.getElementById("purchase-price").value || 0;
    const sale = +document.getElementById("sale-price").value || 0;
    const discount = +document.getElementById("discount").value || 0;
    const qty = +document.getElementById("quantity").value || 0;

    const profit = (sale - pur - discount) * qty;
    const total = (sale - discount) * qty;

    document.getElementById("profit").value = profit > 0 ? formatNumber(profit) : 0;
    document.getElementById("total").value = total > 0 ? formatNumber(total) : 0;
  };

  // Ø«Ø¨Øª ÙØ±ÙˆØ´ Ø¬Ø¯ÛŒØ¯
  document.getElementById("sale-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const name = document.getElementById("product-name").value.trim();
    const description = document.getElementById("product-description").value.trim();
    const purchasePrice = +document.getElementById("purchase-price").value.trim();
    const salePrice = +document.getElementById("sale-price").value.trim();
    const quantity = +document.getElementById("quantity").value.trim();
    const discount = +document.getElementById("discount").value.trim();

    let image = "";
    const imgInput = document.getElementById("product-image");
    if (imgInput.files.length > 0) {
      // ØªØ¨Ø¯ÛŒÙ„ Ø¹Ú©Ø³ Ø¨Ù‡ base64 (Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª)
      const file = imgInput.files[0];
      image = await toBase64(file);
    } else {
      image = "https://via.placeholder.com/80?text=No+Image";
    }

    if (!name || !description || !purchasePrice || !salePrice || !quantity) {
      alert("Ù„Ø·ÙØ§ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.");
      return;
    }

    // Ù…Ù‚Ø¯Ø§Ø± Ø³ÙˆØ¯ Ùˆ Ø¬Ù…Ø¹ Ú©Ù„
    const profit = (salePrice - purchasePrice - discount) * quantity;
    const total = (salePrice - discount) * quantity;

    try {
      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "add",
          name,
          description,
          purchasePrice,
          salePrice,
          quantity,
          discount,
          profit,
          total,
          image,
          inventory: quantity
        }),
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();

      if (result.success) {
        alert("ÙØ±ÙˆØ´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
        // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙØ±Ù…
        e.target.reset();
        fetchSales();
      } else {
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙØ±ÙˆØ´.");
      }
    } catch (err) {
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.");
      console.error(err);
    }
  });

  // ØªØ¨Ø¯ÛŒÙ„ ÙØ§ÛŒÙ„ Ø¹Ú©Ø³ Ø¨Ù‡ base64
  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  // Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„ ÙØ±ÙˆØ´â€ŒÙ‡Ø§ Ø¯Ø± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
  function renderTable() {
    tbody.innerHTML = "";

    sales.forEach((item, idx) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td><img src="${item.image}" alt="img" /></td>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>${formatNumber(item.purchasePrice)}</td>
        <td>${formatNumber(item.salePrice)}</td>
        <td>${item.quantity}</td>
        <td>${formatNumber(item.discount)}</td>
        <td>${formatNumber(item.profit)}</td>
        <td>${formatNumber(item.total)}</td>
        <td>${item.inventory}</td>
        <td><button class="btn" onclick="deleteSale(${idx})">Ø­Ø°Ù</button></td>
      `;

      tbody.appendChild(tr);
    });
  }

  // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÙˆÙ„ ÙØ±ÙˆØ´
  function searchTable() {
    const filter = document.getElementById("search").value.toLowerCase();
    const rows = tbody.getElementsByTagName("tr");

    for (let row of rows) {
      const cells = row.getElementsByTagName("td");
      const nameCell = cells[1];
      if (nameCell) {
        const text = nameCell.textContent || nameCell.innerText;
        row.style.display = text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
      }
    }
  }

  // Ø­Ø°Ù ÙØ±ÙˆØ´ (Ø±Ø¯ÛŒÙ) Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª
  async function deleteSale(idx) {
    if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) return;

    try {
      const res = await fetch(SHEET_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "delete",
          rowId: sales[idx].rowId
        }),
        headers: { "Content-Type": "application/json" }
      });
      const result = await res.json();

      if (result.success) {
        sales.splice(idx, 1);
        renderCards();
        renderTable();
      } else {
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙØ±ÙˆØ´.");
      }
    } catch (err) {
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.");
      console.error(err);
    }
  }

  // Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡
  fetchSales();

</script>

</body>
</html>
