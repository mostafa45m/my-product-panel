<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>محصولات و پنل مدیریت</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- … استایل‌ها مشابه نسخه‌ی قبلی … -->
</head>
<body>
<div id="mainContent">
  <h2>📦 محصولات ثبت‌شده</h2>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="🔍 جست‌وجوی محصول..." oninput="renderCards()" />
  </div>
  <div id="product-list"></div>
</div>

<button id="adminBtn" onclick="enterAdmin()">پنل مدیریت</button>

<div id="adminPanel" style="display:none">
  <h2>پنل فروش</h2>
  <form id="sale-form">
    <!-- فیلدهای فرم شامل نام، توضیحات، تصویر، قیمت، تخفیف و تعداد -->
    <input type="text" id="product-name" placeholder="نام محصول" required>
    <textarea id="product-description" placeholder="توضیحات" required></textarea>
    <input type="file" id="product-image" accept="image/*">
    <input type="number" id="purchase-price" placeholder="قیمت خرید" required>
    <input type="number" id="sale-price" placeholder="قیمت فروش" required>
    <input type="number" id="quantity" placeholder="تعداد" required>
    <input type="number" id="discount" placeholder="تخفیف" required>
    <input type="text" id="profit" placeholder="سود" readonly>
    <input type="text" id="total" placeholder="جمع کل" readonly>
    <button type="submit">ثبت فروش</button>
  </form>

  <h3>لیست فروش‌ها</h3>
  <input type="text" id="search" placeholder="جست‌وجو در جدول..." onkeyup="searchTable()">
  <table id="sale-table">
    <thead>…</thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbwK18qdDdMLMl3v5ZiOLycJOxPwIY_1A1ZEC3O9G4UhxzAnRS3CF_hbf75dPNTUB3GH8g/exec";
  let sales = [];

  function formatNumber(n) {
    return Number(n).toLocaleString("fa-IR");
  }

  function loadSales() {
    fetch(SHEET_URL + "?action=load")
      .then(r => r.json())
      .then(data => { sales = data; renderCards(); renderTable(); })
      .catch(err => alert("خطا در بارگذاری: " + err));
  }

  function saveSale(item, callback) {
    fetch(SHEET_URL + "?action=add", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(item)
    })
    .then(r => r.json())
    .then(callback)
    .catch(err => alert("خطا در ذخیره: " + err));
  }

  function updateSale(item, callback) {
    fetch(SHEET_URL + "?action=update", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(item)
    })
    .then(r => r.json())
    .then(callback)
    .catch(err => alert("خطا در ویرایش: " + err));
  }

  function deleteSale(id, callback) {
    fetch(SHEET_URL + "?action=delete", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({id})
    })
    .then(r => r.json())
    .then(callback)
    .catch(err => alert("خطا در حذف: " + err));
  }

  function renderCards() {
    const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
    const list = document.getElementById("product-list");
    list.innerHTML = "";
    const filtered = sales.filter(i => i.name.toLowerCase().includes(keyword));
    if (!filtered.length) {
      list.innerHTML = "<p style='text-align:center;color:#777;'>محصولی یافت نشد</p>";
      return;
    }
    filtered.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "product-card";
      const totalUnit = item.salePrice - item.discount;
      card.innerHTML = `
        <img src="${item.image}" alt="">
        <div class="product-info">
          <p><strong>${item.name}</strong></p>
          <p>قیمت: ${formatNumber(item.salePrice)} تومان</p>
          <p>موجودی: ${formatNumber(item.inventory)}</p>
          <p>تخفیف: ${formatNumber(item.discount)}</p>
          <p>قیمت نهایی: ${formatNumber(totalUnit)}</p>
        </div>
        <button class="btn" onclick="decreaseInventory(${idx})">کاهش موجودی</button>
      `;
      list.appendChild(card);
    });
  }

  function decreaseInventory(idx) {
    const count = parseInt(prompt("چند عدد؟"));
    if (isNaN(count) || count < 0) return alert("عدد معتبر");
    const item = {...sales[idx], inventory: sales[idx].inventory - count};
    updateSale(item, () => loadSales());
  }

  function renderTable() {
    const tbody = document.querySelector("#sale-table tbody");
    tbody.innerHTML = "";
    sales.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><img src="${item.image}" width="80"></td>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>${formatNumber(item.purchasePrice)}</td>
        <td>${formatNumber(item.salePrice)}</td>
        <td>${formatNumber(item.quantity)}</td>
        <td>${formatNumber(item.discount)}</td>
        <td>${formatNumber(item.profit)}</td>
        <td>${formatNumber(item.total)}</td>
        <td>${formatNumber(item.inventory)}</td>
        <td>
          <button onclick="editItem(${item.id})">✏️</button>
          <button onclick="if(confirm('حذف؟')) deleteSale(${item.id}, loadSales)">🗑️</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("sale-form").onsubmit = function(e) {
    e.preventDefault();
    const f = this;
    const file = f["product-image"].files[0];
    const getImg = file ? new Promise(r => {
      const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(file);
    }) : Promise.resolve("");
    getImg.then(img => {
      const purchase = +f["purchase-price"].value;
      const sale = +f["sale-price"].value;
      const qty = +f["quantity"].value;
      const disc = +f["discount"].value;
      const item = {
        id: f["product-name"].dataset.editingId || null,
        name: f["product-name"].value,
        description: f["product-description"].value,
        image: img,
        purchasePrice: purchase,
        salePrice: sale,
        quantity: qty,
        inventory: qty,
        discount: disc,
        profit: (sale - purchase - disc) * qty,
        total: sale * qty - disc
      };
      const action = item.id ? updateSale : saveSale;
      action(item, () => {
        f.reset(); loadSales();
        delete f["product-name"].dataset.editingId;
      });
    });
  };

  function editItem(id) {
    const item = sales.find(i => i.id === id);
    const f = document.getElementById("sale-form");
    Object.keys(item).forEach(k => {
      if (f[k]) f[k].value = item[k];
    });
    f["product-name"].dataset.editingId = id;
    enterAdmin(true);
  }

  function enterAdmin(fromEdit=false) {
    const res = fromEdit || prompt("رمز عبور:");
    if (res === "1234") {
      document.getElementById("mainContent").style.display = "none";
      document.getElementById("adminBtn").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";
      loadSales();
    } else {
      alert("رمز اشتباه");
    }
  }

  function searchTable() {
    const val = document.getElementById("search").value.toLowerCase();
    document.querySelectorAll("#sale-table tbody tr").forEach(tr => {
      const nm = tr.cells[1]?.innerText.toLowerCase();
      tr.style.display = nm.includes(val) ? "" : "none";
    });
  }

  loadSales();
</script>
</body>
</html>
