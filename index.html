<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- â€¦ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ù…Ø´Ø§Ø¨Ù‡ Ù†Ø³Ø®Ù‡â€ŒÛŒ Ù‚Ø¨Ù„ÛŒ â€¦ -->
</head>
<body>
<div id="mainContent">
  <h2>ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h2>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ù…Ø­ØµÙˆÙ„..." oninput="renderCards()" />
  </div>
  <div id="product-list"></div>
</div>

<button id="adminBtn" onclick="enterAdmin()">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</button>

<div id="adminPanel" style="display:none">
  <h2>Ù¾Ù†Ù„ ÙØ±ÙˆØ´</h2>
  <form id="sale-form">
    <!-- ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±Ù… Ø´Ø§Ù…Ù„ Ù†Ø§Ù…ØŒ ØªÙˆØ¶ÛŒØ­Ø§ØªØŒ ØªØµÙˆÛŒØ±ØŒ Ù‚ÛŒÙ…ØªØŒ ØªØ®ÙÛŒÙ Ùˆ ØªØ¹Ø¯Ø§Ø¯ -->
    <input type="text" id="product-name" placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„" required>
    <textarea id="product-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª" required></textarea>
    <input type="file" id="product-image" accept="image/*">
    <input type="number" id="purchase-price" placeholder="Ù‚ÛŒÙ…Øª Ø®Ø±ÛŒØ¯" required>
    <input type="number" id="sale-price" placeholder="Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´" required>
    <input type="number" id="quantity" placeholder="ØªØ¹Ø¯Ø§Ø¯" required>
    <input type="number" id="discount" placeholder="ØªØ®ÙÛŒÙ" required>
    <input type="text" id="profit" placeholder="Ø³ÙˆØ¯" readonly>
    <input type="text" id="total" placeholder="Ø¬Ù…Ø¹ Ú©Ù„" readonly>
    <button type="submit">Ø«Ø¨Øª ÙØ±ÙˆØ´</button>
  </form>

  <h3>Ù„ÛŒØ³Øª ÙØ±ÙˆØ´â€ŒÙ‡Ø§</h3>
  <input type="text" id="search" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¬Ø¯ÙˆÙ„..." onkeyup="searchTable()">
  <table id="sale-table">
    <thead>â€¦</thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbwK18qdDdMLMl3v5ZiOLycJOxPwIY_1A1ZEC3O9G4UhxzAnRS3CF_hbf75dPNTUB3GH8g/exec";
  let sales = [];

  function formatNumber(n) {
    return Number(n).toLocaleString("fa-IR");
  }

  function loadSales() {
    fetch(SHEET_URL + "?action=load")
      .then(r => r.json())
      .then(data => { sales = data; renderCards(); renderTable(); })
      .catch(err => alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: " + err));
  }

  function saveSale(item, callback) {
    fetch(SHEET_URL + "?action=add", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(item)
    })
    .then(r => r.json())
    .then(callback)
    .catch(err => alert("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: " + err));
  }

  function updateSale(item, callback) {
    fetch(SHEET_URL + "?action=update", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(item)
    })
    .then(r => r.json())
    .then(callback)
    .catch(err => alert("Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´: " + err));
  }

  function deleteSale(id, callback) {
    fetch(SHEET_URL + "?action=delete", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({id})
    })
    .then(r => r.json())
    .then(callback)
    .catch(err => alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: " + err));
  }

  function renderCards() {
    const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
    const list = document.getElementById("product-list");
    list.innerHTML = "";
    const filtered = sales.filter(i => i.name.toLowerCase().includes(keyword));
    if (!filtered.length) {
      list.innerHTML = "<p style='text-align:center;color:#777;'>Ù…Ø­ØµÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>";
      return;
    }
    filtered.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "product-card";
      const totalUnit = item.salePrice - item.discount;
      card.innerHTML = `
        <img src="${item.image}" alt="">
        <div class="product-info">
          <p><strong>${item.name}</strong></p>
          <p>Ù‚ÛŒÙ…Øª: ${formatNumber(item.salePrice)} ØªÙˆÙ…Ø§Ù†</p>
          <p>Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${formatNumber(item.inventory)}</p>
          <p>ØªØ®ÙÛŒÙ: ${formatNumber(item.discount)}</p>
          <p>Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ: ${formatNumber(totalUnit)}</p>
        </div>
        <button class="btn" onclick="decreaseInventory(${idx})">Ú©Ø§Ù‡Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
      `;
      list.appendChild(card);
    });
  }

  function decreaseInventory(idx) {
    const count = parseInt(prompt("Ú†Ù†Ø¯ Ø¹Ø¯Ø¯ØŸ"));
    if (isNaN(count) || count < 0) return alert("Ø¹Ø¯Ø¯ Ù…Ø¹ØªØ¨Ø±");
    const item = {...sales[idx], inventory: sales[idx].inventory - count};
    updateSale(item, () => loadSales());
  }

  function renderTable() {
    const tbody = document.querySelector("#sale-table tbody");
    tbody.innerHTML = "";
    sales.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><img src="${item.image}" width="80"></td>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>${formatNumber(item.purchasePrice)}</td>
        <td>${formatNumber(item.salePrice)}</td>
        <td>${formatNumber(item.quantity)}</td>
        <td>${formatNumber(item.discount)}</td>
        <td>${formatNumber(item.profit)}</td>
        <td>${formatNumber(item.total)}</td>
        <td>${formatNumber(item.inventory)}</td>
        <td>
          <button onclick="editItem(${item.id})">âœï¸</button>
          <button onclick="if(confirm('Ø­Ø°ÙØŸ')) deleteSale(${item.id}, loadSales)">ğŸ—‘ï¸</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("sale-form").onsubmit = function(e) {
    e.preventDefault();
    const f = this;
    const file = f["product-image"].files[0];
    const getImg = file ? new Promise(r => {
      const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(file);
    }) : Promise.resolve("");
    getImg.then(img => {
      const purchase = +f["purchase-price"].value;
      const sale = +f["sale-price"].value;
      const qty = +f["quantity"].value;
      const disc = +f["discount"].value;
      const item = {
        id: f["product-name"].dataset.editingId || null,
        name: f["product-name"].value,
        description: f["product-description"].value,
        image: img,
        purchasePrice: purchase,
        salePrice: sale,
        quantity: qty,
        inventory: qty,
        discount: disc,
        profit: (sale - purchase - disc) * qty,
        total: sale * qty - disc
      };
      const action = item.id ? updateSale : saveSale;
      action(item, () => {
        f.reset(); loadSales();
        delete f["product-name"].dataset.editingId;
      });
    });
  };

  function editItem(id) {
    const item = sales.find(i => i.id === id);
    const f = document.getElementById("sale-form");
    Object.keys(item).forEach(k => {
      if (f[k]) f[k].value = item[k];
    });
    f["product-name"].dataset.editingId = id;
    enterAdmin(true);
  }

  function enterAdmin(fromEdit=false) {
    const res = fromEdit || prompt("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:");
    if (res === "1234") {
      document.getElementById("mainContent").style.display = "none";
      document.getElementById("adminBtn").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";
      loadSales();
    } else {
      alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡");
    }
  }

  function searchTable() {
    const val = document.getElementById("search").value.toLowerCase();
    document.querySelectorAll("#sale-table tbody tr").forEach(tr => {
      const nm = tr.cells[1]?.innerText.toLowerCase();
      tr.style.display = nm.includes(val) ? "" : "none";
    });
  }

  loadSales();
</script>
</body>
</html>
